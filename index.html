<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M5 Controller</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #1a1a1a; color: #eee; font-family: 'Segoe UI', monospace; text-align: center; margin: 0; padding: 20px; }
        h2 { margin: 0 0 20px 0; color: #00ffcc; text-shadow: 0 0 10px #00ffcc; }
        
        /* Dashboard */
        .dashboard { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .card { background: #333; padding: 15px; border-radius: 8px; width: 120px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .value { font-size: 2.5em; font-weight: bold; color: #fff; }
        .label { font-size: 0.8em; color: #aaa; }
        
        /* Controls */
        .controls { background: #2a2a2a; padding: 20px; border-radius: 10px; max-width: 600px; margin: 0 auto 20px auto; border: 1px solid #444; }
        .control-group { margin-bottom: 15px; text-align: left; }
        .control-label { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; }
        input[type=range] { width: 100%; cursor: pointer; }
        
        /* Buttons */
        .btn-row { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        button { padding: 12px 24px; font-size: 1em; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-connect { background: #007bff; color: white; width: 100%; max-width: 600px; margin-bottom: 20px; }
        .btn-calib { background: #ffaa00; color: black; }
        .btn-reset { background: #dc3545; color: white; }
        button:disabled { background: #555; cursor: not-allowed; }

        /* Chart */
        .chart-container { max-width: 800px; margin: 0 auto; background: #000; border: 1px solid #333; }
        #status { height: 20px; color: #ff5555; margin-bottom: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <h2>M5 STROKE CONTROLLER</h2>
    
    <button id="connectBtn" class="btn-connect" onclick="connectBluetooth()">CONNECT DEVICE</button>
    <div id="status">Disconnected</div>

    <div class="dashboard">
        <div class="card">
            <div class="label">COUNT</div>
            <div class="value" id="dispCount">0</div>
        </div>
        <div class="card">
            <div class="label">BPM</div>
            <div class="value" id="dispBpm">0</div>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="waveChart"></canvas>
    </div>

    <div class="controls">
        <div class="control-group">
            <div class="control-label">
                <span>TRIGGER SENSITIVITY (Threshold)</span>
                <span id="valThresh">0.50</span> G
            </div>
            <input type="range" id="rangeThresh" min="0.1" max="2.0" step="0.05" value="0.5" oninput="updateSettings()" disabled>
            <div class="label" style="margin-top:5px;">← Sensitive (Small Move) | Hard (Big Move) →</div>
        </div>

        <div class="control-group">
            <div class="control-label">
                <span>SPEED LIMIT (Min Interval)</span>
                <span id="valDebounce">150</span> ms
            </div>
            <input type="range" id="rangeDebounce" min="50" max="1000" step="10" value="150" oninput="updateSettings()" disabled>
            <div class="label" style="margin-top:5px;">← Allow Fast | Ignore Fast →</div>
        </div>

        <div class="btn-row">
            <button class="btn-calib" onclick="sendCommand('CAL')" disabled id="btnCalib">AUTO CALIBRATE (3s)</button>
            <button class="btn-reset" onclick="sendCommand('RST')" disabled id="btnReset">RESET COUNT</button>
        </div>
    </div>

    <script>
        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const TX_UUID      = "beb5483e-36e1-4688-b7f5-ea07361b26a8"; // Notify
        const RX_UUID      = "12903522-3783-4044-932f-7671b7642395"; // Write

        let device, server, rxChar, txChar;
        let chart;
        const maxDataPoints = 100;
        let waveData = new Array(maxDataPoints).fill(0);
        let threshData = new Array(maxDataPoints).fill(0.5);
        let negThreshData = new Array(maxDataPoints).fill(-0.5);

        // UI Elements
        const elThresh = document.getElementById('rangeThresh');
        const elDebounce = document.getElementById('rangeDebounce');
        const valThresh = document.getElementById('valThresh');
        const valDebounce = document.getElementById('valDebounce');

        window.onload = function() {
            const ctx = document.getElementById('waveChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: new Array(maxDataPoints).fill(''),
                    datasets: [
                        { label: 'Motion', data: waveData, borderColor: '#00ffcc', borderWidth: 2, pointRadius: 0, tension: 0.1 },
                        { label: 'Limit', data: threshData, borderColor: '#ff5555', borderWidth: 1, borderDash: [5, 5], pointRadius: 0 },
                        { label: 'Limit', data: negThreshData, borderColor: '#ff5555', borderWidth: 1, borderDash: [5, 5], pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true,
                    animation: false,
                    scales: { y: { min: -2, max: 2, grid: { color: '#333' } } },
                    plugins: { legend: { display: false } }
                }
            });
        };

        async function connectBluetooth() {
            try {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: "M5-ONANI-CONTROLLER" }],
                    optionalServices: [SERVICE_UUID]
                });

                document.getElementById('status').innerText = "Connecting...";
                server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                
                txChar = await service.getCharacteristic(TX_UUID);
                rxChar = await service.getCharacteristic(RX_UUID);

                await txChar.startNotifications();
                txChar.addEventListener('characteristicvaluechanged', handleData);

                // UI Enable
                document.getElementById('status').innerText = "CONNECTED";
                document.getElementById('status').style.color = "#00ffcc";
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('btnCalib').disabled = false;
                document.getElementById('btnReset').disabled = false;
                elThresh.disabled = false;
                elDebounce.disabled = false;

            } catch (error) {
                console.error(error);
                document.getElementById('status').innerText = "Connection Failed";
            }
        }

        function handleData(event) {
            const value = new TextDecoder().decode(event.target.value);
            // Format: "Count,BPM,Wave,Threshold,Debounce,IsCalib"
            const [count, bpm, wave, thresh, debounce, isCalib] = value.split(',').map(parseFloat);

            document.getElementById('dispCount').innerText = count;
            document.getElementById('dispBpm').innerText = bpm.toFixed(0);
            
            // Sync slider values with device (only if not dragging)
            // (Optional: You might want the device to follow the UI, not vice versa, 
            // but this keeps them in sync after auto-calibration)
            if (!elThresh.matches(':active')) {
                elThresh.value = thresh;
                valThresh.innerText = thresh.toFixed(2);
            }
            if (!elDebounce.matches(':active')) {
                elDebounce.value = debounce;
                valDebounce.innerText = debounce.toFixed(0);
            }

            if (isCalib === 1) {
                document.getElementById('status').innerText = "CALIBRATING... MOVE!";
                document.getElementById('status').style.color = "yellow";
            } else {
                document.getElementById('status').innerText = "ACTIVE";
                document.getElementById('status').style.color = "#00ffcc";
            }

            // Update Chart
            waveData.push(wave);
            waveData.shift();
            // Use current slider value for immediate visual feedback
            const currentThresh = parseFloat(elThresh.value);
            threshData.push(currentThresh);
            threshData.shift();
            negThreshData.push(-currentThresh);
            negThreshData.shift();

            chart.update();
        }

        // Send Command to M5
        async function sendCommand(cmd) {
            if (!rxChar) return;
            await rxChar.writeValue(new TextEncoder().encode(cmd));
        }

        // Send Settings (Throttled or on Input)
        async function updateSettings() {
            const t = elThresh.value;
            const d = elDebounce.value;
            valThresh.innerText = parseFloat(t).toFixed(2);
            valDebounce.innerText = d;
            
            // "SET:threshold:debounce"
            const cmd = `SET:${t}:${d}`;
            await sendCommand(cmd);
        }
    </script>
</body>
</html>
