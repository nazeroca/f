<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>M5 Audio Essence</title>
<style>
    :root {
        --bg-main: #050008;
        --panel-bg: #100510;
        --neon-pink: #ff0055;
        --neon-blue: #00d2ff;
        --neon-green: #00ff99;
        --text-color: #eee;
    }
    body { background: var(--bg-main); margin: 0; overflow: hidden; font-family: 'Courier New', sans-serif; color: var(--text-color); user-select: none; }
    
    #container { display: flex; flex-direction: column; width: 100vw; height: 100vh; position: relative; }

    /* ãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ã‚¨ãƒªã‚¢ */
    #visualizer-stage {
        flex: 1; position: relative; background: #000; overflow: hidden;
        display: flex; justify-content: center; align-items: center;
        border-bottom: 2px solid var(--neon-pink);
    }
    canvas { position: absolute; top: 0; left: 0; }

    /* æƒ…å ±ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .info-overlay {
        position: absolute; top: 20px; left: 0; width: 100%; text-align: center;
        pointer-events: none; z-index: 10;
    }
    #filename { color: var(--neon-blue); font-size: 14px; margin-bottom: 5px; text-shadow: 0 0 5px var(--neon-blue); }
    #time-display { font-size: 24px; font-weight: bold; color: #fff; }
    #speed-indicator { 
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        font-size: 80px; font-weight: bold; opacity: 0; transition: opacity 0.2s;
        color: var(--neon-green); text-shadow: 0 0 20px var(--neon-green); pointer-events: none;
    }

    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
    #control-panel {
        height: 240px; background: var(--panel-bg); padding: 15px; box-sizing: border-box;
        border-top: 1px solid #333; display: flex; flex-direction: column; gap: 10px;
    }

    .row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    
    .btn {
        background: #222; border: 1px solid var(--neon-blue); color: var(--neon-blue);
        padding: 15px 0; border-radius: 6px; font-weight: bold; cursor: pointer; text-align: center;
        flex: 1; transition: 0.1s; font-size: 14px; display: flex; align-items: center; justify-content: center;
    }
    .btn:active { transform: scale(0.96); background: var(--neon-blue); color: #000; }
    .btn-main { border-color: var(--neon-pink); color: var(--neon-pink); box-shadow: 0 0 10px rgba(255,0,85,0.2); }
    .btn-main:active { background: var(--neon-pink); }
    
    .slider-group { flex: 1; display: flex; flex-direction: column; font-size: 10px; color: #aaa; }
    input[type=range] { width: 100%; accent-color: var(--neon-pink); margin-top: 5px; }

    /* ãƒ¡ãƒ¼ã‚¿ãƒ¼é¡ */
    .meter-box { width: 60px; text-align: right; }
    .val-disp { font-size: 14px; color: var(--neon-green); }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ãƒ³ãƒ— */
    #status-lamp {
        width: 10px; height: 10px; border-radius: 50%; background: #333;
        box-shadow: 0 0 5px #000; transition: 0.1s;
    }

    /* ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› */
    input[type="file"] { display: none; }

    /* åˆæœŸç”»é¢ */
    #init-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999;
        background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .start-btn {
        padding: 20px 50px; font-size: 24px; border-radius: 50px; margin-top: 30px; cursor: pointer;
        background: var(--neon-pink); color: #fff; font-weight: bold; border: 2px solid #fff;
        box-shadow: 0 0 30px var(--neon-pink); animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

</style>
</head>
<body>

<div id="container">
    <div id="visualizer-stage">
        <canvas id="vis-canvas"></canvas>
        <div class="info-overlay">
            <div id="filename">NO FILE</div>
            <div id="time-display">00:00 / 00:00</div>
        </div>
        <div id="speed-indicator">SKIP &gt;&gt;&gt;</div>
    </div>

    <div id="control-panel">
        <div class="row">
            <label class="btn btn-main">
                ğŸ“‚ LOAD FOLDER
                <input type="file" id="file-input" webkitdirectory directory multiple accept="audio/*">
            </label>
            <div id="status-lamp"></div>
            <div style="font-size:10px; color:#666;">QUEUE: <span id="queue-count">0</span></div>
        </div>

        <div class="row">
            <button class="btn" onclick="seek(-30)">âª -30s</button>
            <button class="btn" onclick="togglePlay()" id="play-btn">PLAY</button>
            <button class="btn" onclick="seek(30)">+30s â©</button>
        </div>
        
        <div class="row">
            <button class="btn" style="border-color:var(--neon-green); color:var(--neon-green);" onclick="jumpToClimax()">
                ğŸš€ CLIMAX JUMP
            </button>
            <button class="btn" onclick="playNext()">NEXT TRACK â­</button>
        </div>

        <div class="row">
            <div class="slider-group">
                <span>SILENCE THRESHOLD (Auto Skip)</span>
                <input type="range" id="thresh-slider" min="0" max="50" value="10">
            </div>
            <div class="meter-box">
                <span id="thresh-val" class="val-disp">10</span>
            </div>
        </div>
        
        <div class="row">
            <div class="slider-group">
                <span>MAX SPEED (During Silence)</span>
                <input type="range" id="speed-slider" min="2" max="10" value="5">
            </div>
            <div class="meter-box">
                <span id="speed-val" class="val-disp">x5.0</span>
            </div>
        </div>
    </div>
</div>

<div id="init-screen">
    <h1 style="color:var(--neon-pink); text-shadow:0 0 20px var(--neon-pink); font-size:40px; margin:0;">M5 AUDIO</h1>
    <div style="color:var(--neon-blue); letter-spacing:4px; margin-bottom:20px;">ESSENCE EXTRACTOR</div>
    <label class="start-btn">
        ğŸ§ LOAD AUDIO
        <input type="file" id="init-file-input" webkitdirectory directory multiple accept="audio/*">
    </label>
</div>

<script>
    // === å¤‰æ•° ===
    const canvas = document.getElementById('vis-canvas');
    const ctx = canvas.getContext('2d');
    
    // Audio Context
    let audioCtx, analyser, source;
    let audioEl = new Audio();
    audioEl.crossOrigin = "anonymous";
    
    // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ
    let playlist = [];
    
    // è¨­å®š
    let silenceThreshold = 10; // 0-255 (ä½ã„ã»ã©æ•æ„Ÿã«ã‚¹ã‚­ãƒƒãƒ—)
    let skipSpeed = 5.0;       // ã‚¹ã‚­ãƒƒãƒ—æ™‚ã®é€Ÿåº¦
    let normalSpeed = 1.0;
    
    // UIè¦ç´ 
    const filenameDisp = document.getElementById('filename');
    const timeDisp = document.getElementById('time-display');
    const speedInd = document.getElementById('speed-indicator');
    const statusLamp = document.getElementById('status-lamp');
    const playBtn = document.getElementById('play-btn');
    
    // === åˆæœŸåŒ– ===
    document.getElementById('init-file-input').addEventListener('change', handleFiles);
    document.getElementById('file-input').addEventListener('change', handleFiles);

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼é€£å‹•
    document.getElementById('thresh-slider').addEventListener('input', (e) => {
        silenceThreshold = parseInt(e.target.value);
        document.getElementById('thresh-val').innerText = silenceThreshold;
    });
    document.getElementById('speed-slider').addEventListener('input', (e) => {
        skipSpeed = parseFloat(e.target.value);
        document.getElementById('speed-val').innerText = "x" + skipSpeed.toFixed(1);
    });

    // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—å…¨ç”»é¢
    let lastTap = 0;
    document.getElementById('visualizer-stage').addEventListener('click', () => {
        const now = Date.now();
        if (now - lastTap < 300) {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
            else if (document.exitFullscreen) document.exitFullscreen();
        }
        lastTap = now;
    });

    function initAudio() {
        if (audioCtx) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256; // è»½ã‚ã«
        
        source = audioCtx.createMediaElementSource(audioEl);
        source.connect(analyser);
        analyser.connect(audioCtx.destination);
    }

    function handleFiles(e) {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        
        // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿æŠ½å‡º
        const audioFiles = files.filter(f => f.type.startsWith('audio/'));
        if (audioFiles.length === 0) return;

        playlist = playlist.concat(audioFiles);
        shuffleArray(playlist);
        
        document.getElementById('queue-count').innerText = playlist.length;
        document.getElementById('init-screen').style.display = 'none';
        
        initAudio();
        playNext();
        renderLoop();
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function playNext() {
        if (playlist.length === 0) return;
        const file = playlist.shift();
        playlist.push(file); // ãƒ«ãƒ¼ãƒ—

        const url = URL.createObjectURL(file);
        audioEl.src = url;
        audioEl.load();
        
        filenameDisp.innerText = file.name;
        
        audioEl.play().then(() => {
            playBtn.innerText = "PAUSE";
            // é–‹å§‹ç›´å¾Œã¯å°‘ã—é£›ã°ã™ï¼ˆç„¡éŸ³å°å…¥ã‚«ãƒƒãƒˆï¼‰
            // audioEl.currentTime = 5; 
        }).catch(console.error);
        
        // ãƒˆãƒ©ãƒƒã‚¯çµ‚äº†æ™‚
        audioEl.onended = () => {
            playNext();
        };
    }

    function togglePlay() {
        if (audioEl.paused) {
            audioCtx.resume();
            audioEl.play();
            playBtn.innerText = "PAUSE";
        } else {
            audioEl.pause();
            playBtn.innerText = "PLAY";
        }
    }

    function seek(sec) {
        audioEl.currentTime += sec;
    }

    function jumpToClimax() {
        if (!audioEl.duration) return;
        // 60% ã€œ 90% ã®é–“ã¸é£›ã¶
        const range = 0.9 - 0.6;
        const targetRatio = 0.6 + (Math.random() * range);
        audioEl.currentTime = audioEl.duration * targetRatio;
        
        // é€Ÿåº¦ã‚’å°‘ã—è½ã¨ã™ï¼ˆå‘³ã‚ã†ãƒ¢ãƒ¼ãƒ‰ï¼‰
        // normalSpeed = 0.9; 
        // audioEl.playbackRate = 0.9;
    }

    // === ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ï¼ˆè§£æï¼†æç”»ï¼‰ ===
    function renderLoop() {
        requestAnimationFrame(renderLoop);
        
        // Canvasã‚µã‚¤ã‚ºèª¿æ•´
        const w = canvas.parentElement.clientWidth;
        const h = canvas.parentElement.clientHeight;
        if (canvas.width !== w || canvas.height !== h) {
            canvas.width = w;
            canvas.height = h;
        }

        if (!analyser) return;

        // 1. è§£æãƒ‡ãƒ¼ã‚¿å–å¾—
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(dataArray);

        // 2. éŸ³é‡ï¼ˆã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼‰è¨ˆç®—
        let sum = 0;
        for (let i = 0; i < bufferLength; i++) {
            sum += dataArray[i];
        }
        const average = sum / bufferLength; // 0 - 255

        // 3. è‡ªå‹•å¤‰é€Ÿãƒ­ã‚¸ãƒƒã‚¯ (The Silence Skipper)
        // éŸ³é‡ãŒé–¾å€¤ã‚’ä¸‹å›ã£ãŸã‚‰åŠ é€Ÿã€ä¸Šå›ã£ãŸã‚‰ç­‰å€
        if (average < silenceThreshold) {
            // ç„¡éŸ³ï¼ˆé€€å±ˆï¼‰
            audioEl.playbackRate = skipSpeed;
            speedInd.style.opacity = 0.8; // "SKIP >>>" è¡¨ç¤º
            statusLamp.style.background = "#333";
            statusLamp.style.boxShadow = "none";
        } else {
            // éŸ³ã‚ã‚Šï¼ˆé‡è¦ï¼‰
            audioEl.playbackRate = normalSpeed;
            speedInd.style.opacity = 0;
            
            // ãƒ©ãƒ³ãƒ—ã‚’éŸ³ã«åˆã‚ã›ã¦æ˜æ»…
            const hue = 180 + (average * 2); // è‰²å¤‰åŒ–
            statusLamp.style.background = `hsl(${hue}, 100%, 60%)`;
            statusLamp.style.boxShadow = `0 0 ${average/5}px hsl(${hue}, 100%, 60%)`;
        }

        // 4. ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼æç”»
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, w, h);

        const cx = w / 2;
        const cy = h / 2;
        const radius = Math.min(w, h) / 3;

        // å††å½¢ã‚¹ãƒšã‚¯ãƒˆãƒ©ãƒ 
        ctx.beginPath();
        for (let i = 0; i < bufferLength; i++) {
            const barHeight = dataArray[i] * 0.8;
            const rad = (i / bufferLength) * Math.PI * 2;
            
            // ãƒ™ãƒ¼ã‚¹å†† + æ³¢å½¢
            const r = radius + (barHeight * 0.5);
            const x = cx + Math.cos(rad) * r;
            const y = cy + Math.sin(rad) * r;

            const hue = (i / bufferLength) * 360 + (average); // è‰²å›è»¢
            ctx.strokeStyle = `hsl(${hue}, 100%, 50%)`;
            ctx.lineWidth = 2;
            
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        }
        ctx.closePath();
        ctx.stroke();

        // ä¸­å¤®ã®è„ˆå‹•å††
        ctx.beginPath();
        ctx.arc(cx, cy, radius * (0.5 + average/400), 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255, 0, 85, ${average/255})`;
        ctx.fill();

        // æ™‚é–“æ›´æ–°
        const cur = formatTime(audioEl.currentTime);
        const dur = formatTime(audioEl.duration || 0);
        timeDisp.innerText = `${cur} / ${dur}`;
    }

    function formatTime(sec) {
        const m = Math.floor(sec / 60);
        const s = Math.floor(sec % 60);
        return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

</script>
</body>
</html>
