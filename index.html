<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M5 Ultimate Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* === 基本スタイル (スクロール禁止・黒背景) === */
        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: #000; color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            touch-action: manipulation; user-select: none;
        }

        /* コンテナ */
        .container {
            display: flex; flex-direction: column;
            height: 100dvh; padding: 10px; box-sizing: border-box;
        }

        /* 接続ボタン */
        .btn-connect {
            width: 100%; padding: 12px; margin-bottom: 10px;
            background: #007bff; color: white; border: none; border-radius: 6px;
            font-weight: bold; font-size: 16px; cursor: pointer;
        }

        /* ダッシュボード (回数・BPM) */
        .dashboard {
            display: flex; gap: 10px; flex: 0 0 90px; margin-bottom: 10px;
        }
        .card {
            flex: 1; background: #1a1a1a; border: 1px solid #333; border-radius: 8px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .val { font-size: 36px; font-weight: bold; font-family: monospace; line-height: 1; }
        .lbl { font-size: 10px; color: #888; margin-top: 5px; }
        #val-count { color: #00ffcc; }
        #val-bpm { color: #ff5555; }

        /* グラフエリア */
        .chart-wrapper {
            flex: 1; position: relative; width: 100%;
            background: #080808; border: 1px solid #222; border-radius: 8px;
            margin-bottom: 10px; overflow: hidden;
        }

        /* 操作パネル */
        .controls {
            flex: 0 0 auto; background: #111; padding: 10px;
            border-radius: 8px; border: 1px solid #333;
            display: flex; flex-direction: column; gap: 10px;
        }

        /* 自動調整ボタン群 */
        .wiz-label { font-size: 11px; color: #aaa; margin-bottom: -5px; }
        .btn-row { display: flex; gap: 5px; }
        .btn-cal {
            flex: 1; padding: 12px 2px; border: none; border-radius: 4px;
            color: #fff; font-size: 12px; font-weight: bold; cursor: pointer;
            position: relative; overflow: hidden;
        }
        .btn-cal span { display: block; font-size: 9px; opacity: 0.7; font-weight: normal; margin-top: 2px; }
        #btn-range { background: linear-gradient(135deg, #0056b3, #003060); }
        #btn-fast  { background: linear-gradient(135deg, #b30047, #600020); }
        #btn-slow  { background: linear-gradient(135deg, #5e00b3, #300060); }
        
        /* 実行中スタイル */
        .active-cal { border: 2px solid #fff; box-shadow: 0 0 10px rgba(255,255,255,0.5); }

        /* 手動スライダー群 */
        .manual-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
        }
        .slider-box { background: #222; padding: 6px; border-radius: 4px; }
        .slider-header { display: flex; justify-content: space-between; font-size: 10px; color: #888; margin-bottom: 4px; }
        .s-val { color: #00ffcc; font-weight: bold; }
        input[type=range] { width: 100%; margin: 0; cursor: pointer; display: block; }

        /* リセットボタン */
        .btn-reset {
            background: #dc3545; color: white; border: none; padding: 8px;
            border-radius: 4px; font-weight: bold; width: 100%; font-size: 12px;
        }

        button:disabled, input:disabled { opacity: 0.3; pointer-events: none; }
    </style>
</head>
<body>

<div class="container">
    <button id="btnConnect" class="btn-connect" onclick="connectDevice()">デバイス接続 (Start)</button>

    <div class="dashboard">
        <div class="card">
            <span class="val" id="val-count">0</span>
            <span class="lbl">COUNT</span>
        </div>
        <div class="card">
            <span class="val" id="val-bpm">0</span>
            <span class="lbl">BPM</span>
        </div>
    </div>

    <div class="chart-wrapper">
        <canvas id="mainChart"></canvas>
    </div>

    <div class="controls">
        <div class="wiz-label">▼ 自動学習 (各5秒)</div>
        <div class="btn-row">
            <button id="btn-range" class="btn-cal" onclick="send('CAL:RANGE')" disabled>
                1.範囲<span>(最大〜最小)</span>
            </button>
            <button id="btn-fast" class="btn-cal" onclick="send('CAL:FAST')" disabled>
                2.最速<span>(連打測定)</span>
            </button>
            <button id="btn-slow" class="btn-cal" onclick="send('CAL:SLOW')" disabled>
                3.最遅<span>(停止測定)</span>
            </button>
        </div>

        <div class="wiz-label" style="margin-top:5px;">▼ 手動微調整 (オート結果を上書き)</div>
        <div class="manual-grid">
            <div class="slider-box">
                <div class="slider-header">判定ライン(上) <span class="s-val" id="v-h">0.50</span></div>
                <input type="range" id="sl-h" min="-1.5" max="1.5" step="0.05" oninput="manualUpdate()" disabled>
            </div>
            <div class="slider-box">
                <div class="slider-header">判定ライン(下) <span class="s-val" id="v-l">-0.50</span></div>
                <input type="range" id="sl-l" min="-1.5" max="1.5" step="0.05" oninput="manualUpdate()" disabled>
            </div>
            <div class="slider-box">
                <div class="slider-header">連打無視(ms) <span class="s-val" id="v-d">150</span></div>
                <input type="range" id="sl-d" min="10" max="1000" step="10" oninput="manualUpdate()" disabled>
            </div>
            <div class="slider-box">
                <div class="slider-header">停止判定(ms) <span class="s-val" id="v-t">2000</span></div>
                <input type="range" id="sl-t" min="500" max="8000" step="100" oninput="manualUpdate()" disabled>
            </div>
        </div>

        <button class="btn-reset" onclick="send('RST')" id="btnReset" disabled>カウントリセット</button>
    </div>
</div>

<script>
    // === UUID 定義 (M5側と一致・修正済み) ===
    const UUID_S = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
    const UUID_T = "beb5483e-36e1-4688-b7f5-ea07361b26a8"; // Notify (M5->PC)
    const UUID_R = "12903522-3783-4044-932f-7671b7642395"; // Write  (PC->M5)

    let device, rxChar;
    let chart;
    const maxData = 100;
    
    // グラフ用データ
    let dWave = new Array(maxData).fill(0);
    let dHigh = new Array(maxData).fill(0.5);
    let dLow  = new Array(maxData).fill(-0.5);

    // DOM要素キャッシュ
    const slH = document.getElementById('sl-h'), vH = document.getElementById('v-h');
    const slL = document.getElementById('sl-l'), vL = document.getElementById('v-l');
    const slD = document.getElementById('sl-d'), vD = document.getElementById('v-d');
    const slT = document.getElementById('sl-t'), vT = document.getElementById('v-t');

    // === 初期化 ===
    window.onload = () => {
        // ダブルタップ全画面化
        let lt = 0;
        document.body.addEventListener('touchend', e => {
            if(new Date().getTime()-lt < 300) {
                if(!document.fullscreenElement) document.documentElement.requestFullscreen();
                else document.exitFullscreen();
            }
            lt = new Date().getTime();
        });

        // グラフ描画設定
        const ctx = document.getElementById('mainChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: new Array(maxData).fill(''),
                datasets: [
                    { data: dWave, borderColor: '#00ffcc', borderWidth: 2, pointRadius: 0, tension: 0.1 },
                    { data: dHigh, borderColor: 'rgba(255,100,100,0.8)', borderWidth: 1, borderDash:[5,5], pointRadius:0 },
                    { data: dLow,  borderColor: 'rgba(255,100,100,0.8)', borderWidth: 1, borderDash:[5,5], pointRadius:0 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, animation: false,
                plugins: { legend: { display: false } },
                scales: { 
                    y: { min: -1.5, max: 1.5, grid: { color: '#222' } },
                    x: { display: false }
                }
            }
        });
    };

    // === Bluetooth接続 ===
    async function connectDevice() {
        try {
            // 変数名を UUID_S に修正済み
            device = await navigator.bluetooth.requestDevice({
                filters: [{ name: "M5-ULTIMATE-STROKER" }],
                optionalServices: [UUID_S]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(UUID_S);
            rxChar = await service.getCharacteristic(UUID_R);
            const txChar = await service.getCharacteristic(UUID_T);

            await txChar.startNotifications();
            txChar.addEventListener('characteristicvaluechanged', onData);

            // UI有効化
            document.getElementById('btnConnect').style.display = 'none';
            document.querySelectorAll('button, input').forEach(e => e.disabled = false);
            
            // 画面常時点灯 (Wake Lock)
            try { if(navigator.wakeLock) await navigator.wakeLock.request('screen'); } catch(e){}

        } catch(e) { alert("接続エラー: " + e); }
    }

    // === データ受信 (20Hz) ===
    function onData(event) {
        const str = new TextDecoder().decode(event.target.value);
        // Format: "Cnt, BPM, Raw, Hi, Lo, Deb, Tout, Mode"
        const [c, b, r, h, l, d, t, m] = str.split(',').map(parseFloat);

        // 数値更新
        document.getElementById('val-count').innerText = c;
        document.getElementById('val-bpm').innerText = b.toFixed(0);

        // スライダー同期 (操作中でない時のみ)
        if(!slH.matches(':active')) { slH.value = h; vH.innerText = h.toFixed(2); }
        if(!slL.matches(':active')) { slL.value = l; vL.innerText = l.toFixed(2); }
        if(!slD.matches(':active')) { slD.value = d; vD.innerText = d.toFixed(0); }
        if(!slT.matches(':active')) { slT.value = t; vT.innerText = t.toFixed(0); }

        // キャリブレーション状態の表示
        const btns = ['btn-range', 'btn-fast', 'btn-slow'];
        btns.forEach((id, idx) => {
            const el = document.getElementById(id);
            if(m === idx + 1) el.classList.add('active-cal');
            else el.classList.remove('active-cal');
        });

        // グラフ更新
        dWave.push(r); dWave.shift();
        dHigh.push(h); dHigh.shift();
        dLow.push(l); dLow.shift();
        chart.update();
    }

    // === コマンド送信 ===
    async function send(cmd) {
        if(rxChar) await rxChar.writeValue(new TextEncoder().encode(cmd));
    }

    // === 手動スライダー操作時 ===
    let lastTime = 0;
    function manualUpdate() {
        const now = new Date().getTime();
        // 表示更新
        vH.innerText = parseFloat(slH.value).toFixed(2);
        vL.innerText = parseFloat(slL.value).toFixed(2);
        vD.innerText = slD.value;
        vT.innerText = slT.value;

        // 通信間引き (100msに1回)
        if(now - lastTime > 100) {
            // SET:High:Low:Deb:Tout
            const cmd = `SET:${slH.value}:${slL.value}:${slD.value}:${slT.value}`;
            send(cmd);
            lastTime = now;
        }
    }
</script>
</body>
</html>
